# autoweKPI çŸ¥è¯†åº“

## ğŸ“š æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯autoweKPIé¡¹ç›®çš„ç³»ç»ŸçŸ¥è¯†åº“ï¼Œè®°å½•å…³é”®æŠ€æœ¯å†³ç­–ã€æœ€ä½³å®è·µã€é—®é¢˜è§£å†³æ–¹æ¡ˆå’Œç»éªŒæ•™è®­ï¼Œä½œä¸ºé¡¹ç›®çš„é•¿æœŸç»´æŠ¤æŒ‡å—ã€‚

**æœ€åæ›´æ–°**: 2025-12-11
**ç»´æŠ¤äºº**: å¼€å‘å›¢é˜Ÿ
**ç‰ˆæœ¬**: v1.0

---

## ç›®å½•

1. [é¡¹ç›®æ¶æ„](#é¡¹ç›®æ¶æ„)
2. [æŠ€æœ¯å†³ç­–è®°å½•](#æŠ€æœ¯å†³ç­–è®°å½•)
3. [æ ¸å¿ƒæ¨¡å—è¯´æ˜](#æ ¸å¿ƒæ¨¡å—è¯´æ˜)
4. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
5. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
6. [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](#æ€§èƒ½ä¼˜åŒ–æŒ‡å—)
7. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
8. [éƒ¨ç½²ä¸è¿ç»´](#éƒ¨ç½²ä¸è¿ç»´)

---

## é¡¹ç›®æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GitHub Pages                    â”‚
â”‚              (é™æ€èµ„æºæ‰˜ç®¡ + CDN)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Vue 3 å•é¡µåº”ç”¨ (SPA)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UIå±‚ (Element Plus)                             â”‚
â”‚  â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ ç»„ä»¶                                 â”‚
â”‚  â”œâ”€â”€ KPIå¡ç‰‡ç»„ä»¶                                 â”‚
â”‚  â”œâ”€â”€ EChartså›¾è¡¨ç»„ä»¶                             â”‚
â”‚  â””â”€â”€ æŠ¥å‘Šè§†å›¾ç»„ä»¶                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€ç®¡ç†å±‚ (Pinia)                               â”‚
â”‚  â”œâ”€â”€ data store: æ•°æ®+KPI+æŠ¥å‘Š                   â”‚
â”‚  â””â”€â”€ config store: é…ç½®+UIçŠ¶æ€                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (Services)                            â”‚
â”‚  â”œâ”€â”€ DataLoader: CSVè§£æ                        â”‚
â”‚  â”œâ”€â”€ KPICalculator: 15ä¸ªKPIè®¡ç®—                 â”‚
â”‚  â”œâ”€â”€ DataAggregator: æ•°æ®èšåˆ                    â”‚
â”‚  â””â”€â”€ BusinessMapper: ä¸šåŠ¡æ˜ å°„                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥å…·å±‚ (Utils)                                   â”‚
â”‚  â”œâ”€â”€ math: æ•°å­¦è®¡ç®—                              â”‚
â”‚  â””â”€â”€ date: æ—¥æœŸå¤„ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç±»å‹å±‚ (Types)                                   â”‚
â”‚  â””â”€â”€ 40+ TypeScriptç±»å‹å®šä¹‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰å‹

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|------|------|----------|
| **å‰ç«¯æ¡†æ¶** | Vue 3 | 3.5.13 | æ¸è¿›å¼ã€TypeScriptæ”¯æŒå¥½ã€å­¦ä¹ æ›²çº¿å¹³ç¼“ |
| **æ„å»ºå·¥å…·** | Vite | 6.0.5 | å¼€å‘ä½“éªŒå¥½ã€æ„å»ºå¿«é€Ÿã€HMRä¼˜ç§€ |
| **ç±»å‹ç³»ç»Ÿ** | TypeScript | 5.7.2 | ä¸¥æ ¼ç±»å‹æ£€æŸ¥ã€IDEæ”¯æŒå¥½ã€é‡æ„å‹å¥½ |
| **çŠ¶æ€ç®¡ç†** | Pinia | 2.2.8 | Composition APIã€ç±»å‹æ¨æ–­å¥½ã€è½»é‡ |
| **UIç»„ä»¶åº“** | Element Plus | 2.9.2 | ç»„ä»¶ä¸°å¯Œã€æ–‡æ¡£å®Œæ•´ã€ç¤¾åŒºæ´»è·ƒ |
| **å›¾è¡¨åº“** | ECharts | 5.5.1 | åŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½å¥½ã€é…ç½®çµæ´» |
| **CSVè§£æ** | PapaParse | 5.4.1 | æ€§èƒ½ä¼˜ç§€ã€ç±»å‹è½¬æ¢å¥½ã€é”™è¯¯å¤„ç†å®Œå–„ |
| **å·¥å…·åº“** | Lodash-es | 4.17.21 | Tree-shakingå‹å¥½ã€APIä¸°å¯Œ |
| **æ—¥æœŸå¤„ç†** | Day.js | 1.11.13 | è½»é‡ã€APIç±»ä¼¼momentã€æ”¯æŒISOå‘¨ |
| **æ•°æ®åº“** | DuckDB WASM | 1.29.0 | æµè§ˆå™¨ç«¯SQLã€æ€§èƒ½å¥½ï¼ˆé¢„ç•™ï¼‰ |

---

## æŠ€æœ¯å†³ç­–è®°å½•

### ADR-001: ä½¿ç”¨Vue 3è€Œä¸æ˜¯React (2025-12-11)

**èƒŒæ™¯**: éœ€è¦é€‰æ‹©å‰ç«¯æ¡†æ¶è¿›è¡ŒPython Flaskåº”ç”¨è¿ç§»

**é€‰é¡¹**:
- React: ç”Ÿæ€æœ€å¤§ï¼Œä½†å­¦ä¹ æ›²çº¿é™¡
- Vue 3: æ¸è¿›å¼ï¼ŒTypeScriptæ”¯æŒå¥½
- Svelte: æ€§èƒ½æœ€ä¼˜ï¼Œä½†ç”Ÿæ€å°

**å†³ç­–**: Vue 3

**ç†ç”±**:
1. æ¸è¿›å¼è®¾è®¡ï¼Œä¾¿äºä»HTMLè¿ç§»
2. Composition API + TypeScriptæ”¯æŒä¼˜ç§€
3. å­¦ä¹ æ›²çº¿å¹³ç¼“ï¼Œé€‚åˆå°å›¢é˜Ÿ
4. ç”Ÿæ€æˆç†Ÿï¼ˆElement Plusã€EChartsé›†æˆå¥½ï¼‰
5. æ€§èƒ½è¶³å¤Ÿï¼ˆè™šæ‹ŸDOMä¼˜åŒ–ï¼‰

**å½±å“**:
- æ­£é¢ï¼šå¼€å‘æ•ˆç‡é«˜ã€ä»£ç å¯ç»´æŠ¤æ€§å¥½
- è´Ÿé¢ï¼šæ— 

**çŠ¶æ€**: âœ… å·²é‡‡çº³

---

### ADR-002: ä½¿ç”¨Pinia Composition APIè€Œä¸æ˜¯Options API (2025-12-11)

**èƒŒæ™¯**: éœ€è¦é€‰æ‹©çŠ¶æ€ç®¡ç†æ–¹å¼

**é€‰é¡¹**:
- Pinia Options API: ä¼ ç»Ÿå†™æ³•ï¼Œç±»ä¼¼Vuex
- Pinia Composition API: setupè¯­æ³•ï¼Œç±»å‹æ¨æ–­å¥½

**å†³ç­–**: Composition API

**ç†ç”±**:
1. ä¸Vue 3 setupè¯­æ³•ä¸€è‡´
2. TypeScriptç±»å‹æ¨æ–­æ›´å¥½
3. é€»è¾‘å¤ç”¨æ›´æ–¹ä¾¿ï¼ˆcomposablesï¼‰
4. æ€§èƒ½ç•¥ä¼˜ï¼ˆç¼–è¯‘ä¼˜åŒ–ï¼‰
5. æœªæ¥è¶‹åŠ¿

**å½±å“**:
- æ­£é¢ï¼šç±»å‹å®‰å…¨ã€ä»£ç ç®€æ´ã€å¯ç»´æŠ¤æ€§é«˜
- è´Ÿé¢ï¼šéœ€è¦ç†Ÿæ‚‰Composition API

**çŠ¶æ€**: âœ… å·²é‡‡çº³

---

### ADR-003: æœåŠ¡å±‚ä½¿ç”¨å•ä¾‹æ¨¡å¼ (2025-12-11)

**èƒŒæ™¯**: æœåŠ¡ç±»éœ€è¦åœ¨å¤šå¤„ä½¿ç”¨

**é€‰é¡¹**:
- æ¯æ¬¡newå®ä¾‹ï¼šçµæ´»ä½†ç®¡ç†å¤æ‚
- å•ä¾‹å¯¼å‡ºï¼šç®€å•ä½†ä¸å¤Ÿçµæ´»
- ä¾èµ–æ³¨å…¥å®¹å™¨ï¼šçµæ´»ä½†è¿‡åº¦è®¾è®¡

**å†³ç­–**: å•ä¾‹å¯¼å‡º

**ç†ç”±**:
1. ç®€åŒ–ä½¿ç”¨ï¼š`import { dataLoader } from '@/services/data-loader'`
2. å…¨å±€å”¯ä¸€å®ä¾‹ï¼Œä¾¿äºçŠ¶æ€å…±äº«
3. TypeScriptç±»å‹æ¨æ–­å®Œæ•´
4. é€‚åˆä¸­å°å‹é¡¹ç›®

**å½±å“**:
- æ­£é¢ï¼šä½¿ç”¨ç®€å•ã€æ— éœ€ä¾èµ–æ³¨å…¥
- è´Ÿé¢ï¼šæµ‹è¯•æ—¶éœ€è¦mockæ•´ä¸ªæ¨¡å—

**çŠ¶æ€**: âœ… å·²é‡‡çº³

---

### ADR-004: TypeScriptä¸¥æ ¼æ¨¡å¼ (2025-12-11)

**èƒŒæ™¯**: éœ€è¦ç¡®å®šTypeScripté…ç½®çº§åˆ«

**é€‰é¡¹**:
- å®½æ¾æ¨¡å¼ï¼šå…¼å®¹æ€§å¥½ä½†ç±»å‹ä¸å®‰å…¨
- ä¸¥æ ¼æ¨¡å¼ï¼šç±»å‹å®‰å…¨ä½†è¦æ±‚é«˜

**å†³ç­–**: ä¸¥æ ¼æ¨¡å¼

**é…ç½®**:
```json
{
  "strict": true,
  "noUnusedLocals": true,
  "noUnusedParameters": true,
  "noFallthroughCasesInSwitch": true,
  "noUncheckedIndexedAccess": true
}
```

**ç†ç”±**:
1. æå‰å‘ç°æ½œåœ¨bug
2. æé«˜ä»£ç è´¨é‡
3. é‡æ„æ›´å®‰å…¨
4. IDEæç¤ºæ›´å‡†ç¡®

**å½±å“**:
- æ­£é¢ï¼šä»£ç è´¨é‡é«˜ã€bugå°‘
- è´Ÿé¢ï¼šåˆæœŸå¼€å‘ç¨æ…¢

**çŠ¶æ€**: âœ… å·²é‡‡çº³

---

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. ç±»å‹ç³»ç»Ÿ (src/types/)

**è®¾è®¡åŸåˆ™**:
- ä¸šåŠ¡å®ä½“ä¼˜å…ˆï¼ˆRawDataRowã€KPIResultï¼‰
- ç»„åˆä¼˜äºç»§æ‰¿
- é¿å…anyç±»å‹
- å¯¼å‡ºç»Ÿä¸€å…¥å£

**æ–‡ä»¶ç»“æ„**:
```
types/
â”œâ”€â”€ data.ts      # åŸå§‹æ•°æ®ã€åˆ†ç»„æ•°æ®ã€åŠ è½½ç»“æœ
â”œâ”€â”€ kpi.ts       # KPIç»“æœã€æŠ¥å‘Šæ‘˜è¦ã€é˜ˆå€¼é…ç½®
â”œâ”€â”€ chart.ts     # å›¾è¡¨ç±»å‹ã€æ•°æ®ç‚¹ã€é…ç½®
â”œâ”€â”€ config.ts    # åº”ç”¨é…ç½®ã€ä¼šè¯çŠ¶æ€
â””â”€â”€ index.ts     # ç»Ÿä¸€å¯¼å‡º
```

**å…³é”®ç±»å‹**:
- `RawDataRow`: CSVåŸå§‹æ•°æ®è¡Œï¼ˆ8ä¸ªå¿…éœ€å­—æ®µï¼‰
- `KPIResult`: 15ä¸ªKPIæŒ‡æ ‡ç»“æœ
- `ReportSummary`: å®Œæ•´æŠ¥å‘Šæ‘˜è¦
- `GroupKPIResult`: åˆ†ç»„KPIç»“æœ

---

### 2. å·¥å…·å‡½æ•° (src/utils/)

#### math.ts - æ•°å­¦å·¥å…·

**æ ¸å¿ƒå‡½æ•°**:
```typescript
// å®‰å…¨é™¤æ³•ï¼ˆé¿å…é™¤é›¶ï¼‰
safeDivide(numerator, denominator, defaultValue = 0)

// å•ä½è½¬æ¢
yuanToWan(yuan)  // å…ƒ -> ä¸‡å…ƒ
wanToYuan(wan)   // ä¸‡å…ƒ -> å…ƒ

// å››èˆäº”å…¥
round(value, decimals = 2)

// ç™¾åˆ†æ¯”è®¡ç®—
percentage(part, total, decimals = 2)

// ç¡®ä¿æ•°å€¼æœ‰æ•ˆï¼ˆNaN -> 0ï¼‰
ensureNumber(value, defaultValue = 0)
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { safeDivide, percentage } from '@/utils/math'

// é¿å…é™¤é›¶
const rate = safeDivide(paid, premium) * 100  // åˆ†æ¯ä¸º0æ—¶è¿”å›0

// è®¡ç®—ç™¾åˆ†æ¯”
const achievementRate = percentage(actual, plan)  // è‡ªåŠ¨*100
```

---

#### date.ts - æ—¥æœŸå·¥å…·

**æ ¸å¿ƒå‡½æ•°**:
```typescript
// è·å–ISOå‘¨çš„å‘¨å…­æ—¥æœŸ
getWeekSaturday(year, week)  // "2025å¹´12æœˆ06æ—¥"

// è·å–å½“å‰å‘¨æ¬¡/å¹´ä»½
getCurrentWeek()
getCurrentYear()

// æ ¼å¼åŒ–æ—¥æœŸ
formatDate(date, format = 'YYYY-MM-DD')
```

**ISOå‘¨è¯´æ˜**:
- ä½¿ç”¨dayjsçš„isoWeekæ’ä»¶
- ç¬¦åˆISO 8601æ ‡å‡†
- æ¯å‘¨ä»å‘¨ä¸€å¼€å§‹
- ç¬¬ä¸€å‘¨åŒ…å«è¯¥å¹´çš„ç¬¬ä¸€ä¸ªå‘¨å››

---

### 3. æœåŠ¡å±‚ (src/services/)

#### DataLoader - æ•°æ®åŠ è½½å™¨

**èŒè´£**: CSVæ–‡ä»¶è§£æã€æ•°æ®éªŒè¯ã€æ•°æ®æ¸…æ´—

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class DataLoader {
  async loadFromFile(file: File): Promise<DataLoadResult>
  parseCSV(content: string): DataLoadResult
  private validateData(data: RawDataRow[]): ValidationError[]
  private cleanData(data: RawDataRow[]): RawDataRow[]
  getStatistics(data: RawDataRow[])
}
```

**ç‰¹æ€§**:
- ä½¿ç”¨PapaParseè§£æCSV
- è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆdynamicTypingï¼‰
- å¿…éœ€åˆ—éªŒè¯ï¼ˆ8ä¸ªå¿…éœ€å­—æ®µï¼‰
- æ•°å€¼å­—æ®µæ¸…æ´—ï¼ˆNaN -> 0ï¼‰
- å‹å¥½çš„é”™è¯¯æç¤º

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
import { dataLoader } from '@/services/data-loader'

const result = await dataLoader.loadFromFile(file)
if (result.success) {
  console.log('æ•°æ®è¡Œæ•°:', result.rowCount)
  console.log('åˆ—æ•°:', result.columnCount)
} else {
  console.error('é”™è¯¯:', result.errors)
}
```

---

#### KPICalculator - KPIè®¡ç®—å¼•æ“

**èŒè´£**: è®¡ç®—15ä¸ªKPIæŒ‡æ ‡

**15ä¸ªKPIæŒ‡æ ‡**:
1. **åŸºç¡€æŒ‡æ ‡** (3ä¸ª): ç­¾å•ä¿è´¹ã€æ»¡æœŸä¿è´¹ã€å·²èµšä¿è´¹
2. **æˆæœ¬æŒ‡æ ‡** (4ä¸ª): å·²æŠ¥æ¡ˆèµ”ä»˜ã€æœªå†³èµ”æ¬¾ã€è·å®¢æˆæœ¬ã€è¥è¿è´¹ç”¨
3. **æ¯”ç‡æŒ‡æ ‡** (5ä¸ª): æ»¡æœŸèµ”ä»˜ç‡ã€å˜åŠ¨æˆæœ¬ç‡ã€ç»¼åˆæˆæœ¬ç‡ã€è´¹ç”¨ç‡ã€è´¡çŒ®ç‡
4. **è¾¹é™…æŒ‡æ ‡** (1ä¸ª): æ»¡æœŸè¾¹é™…è´¡çŒ®é¢
5. **è¿›åº¦æŒ‡æ ‡** (2ä¸ª): æ»¡æœŸç‡ã€ä¿è´¹è¾¾æˆç‡

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class KPICalculator {
  calculateKPIs(data: RawDataRow[], options?: KPICalculateOptions): KPIResult
  calculateGroupKPIs(groups: Array<{name, data}>, options?): GroupKPIResult[]
  private roundKPIResult(kpi: KPIResult): KPIResult
}
```

**è®¡ç®—å…¬å¼**:
```typescript
// å˜åŠ¨æˆæœ¬ç‡ = (å·²æŠ¥æ¡ˆèµ”ä»˜ + æœªå†³ + è·å®¢æˆæœ¬) / æ»¡æœŸä¿è´¹ * 100
const å˜åŠ¨æˆæœ¬ç‡ = safeDivide(å˜åŠ¨æˆæœ¬, æ»¡æœŸä¿è´¹) * 100

// è´¡çŒ®ç‡ = 100 - å˜åŠ¨æˆæœ¬ç‡
const è´¡çŒ®ç‡ = 100 - å˜åŠ¨æˆæœ¬ç‡

// æ»¡æœŸè¾¹é™…è´¡çŒ®é¢ = æ»¡æœŸä¿è´¹ * è´¡çŒ®ç‡ / 100
const æ»¡æœŸè¾¹é™…è´¡çŒ®é¢ = æ»¡æœŸä¿è´¹ * (è´¡çŒ®ç‡ / 100)
```

**ç²¾åº¦æ§åˆ¶**:
- é‡‘é¢å­—æ®µ: ä¿ç•™2ä½å°æ•°
- æ¯”ç‡å­—æ®µ: ä¿ç•™1ä½å°æ•°

---

#### DataAggregator - æ•°æ®èšåˆå™¨

**èŒè´£**: æŒ‰ç»´åº¦åˆ†ç»„ã€è®¡ç®—åˆ†ç»„KPIã€æ’åº

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class DataAggregator {
  groupByDimension(data, dimension): GroupedData[]
  calculateGroupedKPIs(data, dimension, sortBy?, limit?): GroupKPIResult[]
  isSingleOrgMode(data): boolean
  isMultiOrgMode(data): boolean
  getOrganizationName(data): string
  sortByPremiumProgress(results): GroupKPIResult[]
  getPremiumProgressData(data)
}
```

**åˆ†ç»„ç»´åº¦**:
- `third_level_organization`: ä¸‰çº§æœºæ„
- `customer_category`: å®¢æˆ·ç±»åˆ«
- `business_type_category`: ä¸šåŠ¡ç±»å‹

**æ’åºè§„åˆ™**:
- é»˜è®¤: æŒ‰ç­¾å•ä¿è´¹é™åº
- ä¿è´¹è¿›åº¦: æœ‰è®¡åˆ’æŒ‰è¾¾æˆç‡å‡åºï¼Œæ— è®¡åˆ’æŒ‰ä¿è´¹å‡åº

---

#### BusinessMapper - ä¸šåŠ¡æ˜ å°„å™¨

**èŒè´£**: ä¸šåŠ¡ç±»å‹æ˜ å°„ã€å¼‚å¸¸æ£€æµ‹

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
class BusinessMapper {
  setBusinessTypeMapping(mapping: BusinessTypeMapping)
  setThresholds(thresholds: Partial<ThresholdConfig>)
  applyBusinessTypeMapping(data): RawDataRow[]
  identifyProblemOrganizations(results): ProblemOrganization[]
  getBusinessTypeStatistics(data)
  getCustomerCategoryStatistics(data)
}
```

**å¼‚å¸¸æ£€æµ‹è§„åˆ™**:
1. ç»¼åˆæˆæœ¬ç‡ > 93%
2. ä¿è´¹è¾¾æˆç‡ < 95%ï¼ˆå¦‚æœæœ‰è®¡åˆ’ï¼‰
3. è´¹ç”¨ç‡ > 18%

**è¿”å›ç»“æœ**: å‰5ä¸ªé—®é¢˜æœºæ„

---

### 4. çŠ¶æ€ç®¡ç† (src/stores/)

#### data store - æ•°æ®çŠ¶æ€

**çŠ¶æ€**:
```typescript
{
  rawData: RawDataRow[]        // åŸå§‹æ•°æ®
  loading: boolean             // åŠ è½½çŠ¶æ€
  error: string | null         // é”™è¯¯ä¿¡æ¯
  fileName: string             // æ–‡ä»¶å
  year: number                 // å¹´ä»½
  week: number                 // å‘¨æ¬¡
}
```

**è®¡ç®—å±æ€§**:
```typescript
{
  hasData: boolean             // æ˜¯å¦æœ‰æ•°æ®
  statistics                   // æ•°æ®ç»Ÿè®¡
  isSingleOrgMode             // å•æœºæ„æ¨¡å¼
  organizationName            // æœºæ„åç§°
  summaryKPI                  // æ€»ä½“KPI
  kpiByOrganization           // æŒ‰æœºæ„åˆ†ç»„KPI
  kpiByCustomerCategory       // æŒ‰å®¢æˆ·ç±»åˆ«åˆ†ç»„KPI
  kpiByBusinessType           // æŒ‰ä¸šåŠ¡ç±»å‹åˆ†ç»„KPI
  problemOrganizations        // é—®é¢˜æœºæ„
  reportSummary               // å®Œæ•´æŠ¥å‘Šæ‘˜è¦
}
```

**æ“ä½œæ–¹æ³•**:
```typescript
{
  loadFile(file)              // åŠ è½½CSVæ–‡ä»¶
  setReportConfig(year, week) // è®¾ç½®æŠ¥å‘Šé…ç½®
  clearData()                 // æ¸…é™¤æ•°æ®
  getKPIByDimension(dimension) // è·å–æŒ‡å®šç»´åº¦KPI
}
```

---

#### config store - é…ç½®çŠ¶æ€

**çŠ¶æ€**:
```typescript
{
  appConfig: AppConfig        // åº”ç”¨é…ç½®
  activeTab: string           // å½“å‰Tab
  activeDimension: GroupDimension // å½“å‰ç»´åº¦
  sessionState: SessionState  // ä¼šè¯çŠ¶æ€
}
```

**æ“ä½œæ–¹æ³•**:
```typescript
{
  setActiveTab(tab)           // è®¾ç½®æ¿€æ´»Tab
  setActiveDimension(dimension) // è®¾ç½®æ¿€æ´»ç»´åº¦
  toggleTheme()               // åˆ‡æ¢ä¸»é¢˜
  toggleDuckDB(enabled?)      // å¯ç”¨/ç¦ç”¨DuckDB
  toggleTrend(enabled?)       // å¯ç”¨/ç¦ç”¨è¶‹åŠ¿åˆ†æ
  saveSessionState()          // ä¿å­˜ä¼šè¯çŠ¶æ€
  loadSessionState()          // åŠ è½½ä¼šè¯çŠ¶æ€
  initialize()                // åˆå§‹åŒ–
}
```

**ä¼šè¯æŒä¹…åŒ–**:
- ä½¿ç”¨localStorageå­˜å‚¨
- è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡çš„Tabå’Œç»´åº¦é€‰æ‹©
- é”®å: `autoweKPI_session`

---

## æœ€ä½³å®è·µ

### 1. TypeScriptä½¿ç”¨

âœ… **DO**:
```typescript
// ä½¿ç”¨å…·ä½“ç±»å‹
function calculateKPI(data: RawDataRow[]): KPIResult { }

// ä½¿ç”¨typeè€Œä¸æ˜¯interfaceï¼ˆå¯¹äºè”åˆç±»å‹ï¼‰
type GroupDimension = 'organization' | 'customer' | 'business'

// ä½¿ç”¨å¯é€‰é“¾å’Œç©ºå€¼åˆå¹¶
const value = row.year_plan_premium ?? 0

// é¿å…ç±»å‹æ–­è¨€ï¼Œä½¿ç”¨ç±»å‹å®ˆå«
if (typeof value === 'number') { }
```

âŒ **DON'T**:
```typescript
// é¿å…any
function process(data: any) { }

// é¿å…ç±»å‹æ–­è¨€
const value = data as number

// é¿å…éç©ºæ–­è¨€
const value = data!.field
```

---

### 2. å‘½åè§„èŒƒ

**æ–‡ä»¶å‘½å**: kebab-case
```
data-loader.ts
kpi-calculator.ts
```

**å˜é‡/å‡½æ•°**: camelCase
```typescript
const rawData = []
function calculateKPIs() {}
```

**ç±»å**: PascalCase
```typescript
class DataLoader {}
class KPICalculator {}
```

**å¸¸é‡**: UPPER_SNAKE_CASE
```typescript
const REQUIRED_COLUMNS = []
const DEFAULT_THRESHOLDS = {}
```

**ä¸­æ–‡KPIå­—æ®µ**: ä¿ç•™ä¸­æ–‡ï¼ˆä¸ä¸šåŠ¡å¯¹é½ï¼‰
```typescript
interface KPIResult {
  ç­¾å•ä¿è´¹: number
  æ»¡æœŸèµ”ä»˜ç‡: number
}
```

---

### 3. é”™è¯¯å¤„ç†

âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼**:
```typescript
async function loadFile(file: File): Promise<DataLoadResult> {
  try {
    // ä¸šåŠ¡é€»è¾‘
    return { success: true, data }
  } catch (error) {
    return {
      success: false,
      errors: [{
        type: 'invalid_value',
        message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
      }]
    }
  }
}
```

âœ… **ä½¿ç”¨Resultæ¨¡å¼è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸**:
```typescript
interface DataLoadResult {
  success: boolean
  data?: RawDataRow[]
  errors?: ValidationError[]
}
```

---

### 4. æ€§èƒ½ä¼˜åŒ–

âœ… **ä½¿ç”¨è®¡ç®—å±æ€§ç¼“å­˜**:
```typescript
const summaryKPI = computed(() => {
  if (!hasData.value) return null
  return kpiCalculator.calculateKPIs(rawData.value)
})
```

âœ… **é¿å…ä¸å¿…è¦çš„å“åº”å¼**:
```typescript
// å¤§æ•°ç»„ä½¿ç”¨shallowRef
const rawData = shallowRef<RawDataRow[]>([])

// ä¸éœ€è¦å“åº”å¼çš„ä½¿ç”¨markRaw
const calculator = markRaw(new KPICalculator())
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: CSVè§£æä¸­æ–‡ä¹±ç 

**é—®é¢˜**: æŸäº›CSVæ–‡ä»¶ä¸­æ–‡æ˜¾ç¤ºä¹±ç 

**åŸå› **: æ–‡ä»¶ç¼–ç ä¸æ˜¯UTF-8

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// data-loader.tsä¸­ä½¿ç”¨UTF-8ç¼–ç 
reader.readAsText(file, 'UTF-8')

// å¦‚æœä»æœ‰é—®é¢˜ï¼Œå¯å°è¯•
reader.readAsText(file, 'GBK')
```

---

### Q2: é™¤é›¶é”™è¯¯å¯¼è‡´NaN

**é—®é¢˜**: æŸäº›æœºæ„æ»¡æœŸä¿è´¹ä¸º0ï¼Œå¯¼è‡´æ¯”ç‡è®¡ç®—ä¸ºNaN

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨safeDivideå‡½æ•°
```typescript
import { safeDivide } from '@/utils/math'

// å½“åˆ†æ¯ä¸º0æ—¶è¿”å›0
const rate = safeDivide(paid, premium) * 100
```

---

### Q3: æ—¥æœŸè®¡ç®—ä¸å‡†ç¡®

**é—®é¢˜**: ISOå‘¨è®¡ç®—ç»“æœä¸é¢„æœŸä¸ç¬¦

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨dayjsçš„isoWeekæ’ä»¶ï¼ˆå·²é…ç½®ï¼‰
- ç¡®ä¿ç†è§£ISOå‘¨è§„åˆ™ï¼š
  * æ¯å‘¨ä»å‘¨ä¸€å¼€å§‹
  * ç¬¬ä¸€å‘¨åŒ…å«è¯¥å¹´çš„ç¬¬ä¸€ä¸ªå‘¨å››
  * ä¸€å¹´æœ‰52æˆ–53å‘¨

```typescript
import { getWeekSaturday } from '@/utils/date'

// 2025å¹´ç¬¬49å‘¨çš„å‘¨å…­
const date = getWeekSaturday(2025, 49)  // "2025å¹´12æœˆ06æ—¥"
```

---

### Q4: TypeScriptç±»å‹é”™è¯¯

**é—®é¢˜**: `Type 'X' is not assignable to type 'Y'`

**å¸¸è§åŸå› **:
1. ç±»å‹å¯¼å…¥é”™è¯¯ï¼ˆimport type vs importï¼‰
2. å¯é€‰å­—æ®µæœªå¤„ç†
3. æ•°ç»„ç´¢å¼•è®¿é—®ï¼ˆnoUncheckedIndexedAccessï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// 1. æ­£ç¡®åŒºåˆ†ç±»å‹å¯¼å…¥å’Œå€¼å¯¼å…¥
import type { RawDataRow } from '@/types'  // ç±»å‹
import { DEFAULT_THRESHOLDS } from '@/types/kpi'  // å€¼

// 2. å¤„ç†å¯é€‰å­—æ®µ
const plan = row.year_plan_premium ?? 0

// 3. æ•°ç»„è®¿é—®éœ€è¦æ£€æŸ¥
const firstRow = data[0]
if (firstRow) {
  // ä½¿ç”¨firstRow
}
```

---

## æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 1. å¤§æ•°æ®å¤„ç†ä¼˜åŒ–

**é—®é¢˜**: 10ä¸‡è¡Œæ•°æ®å¤„ç†å¯èƒ½å¡é¡¿

**ä¼˜åŒ–æ–¹æ¡ˆ**:
1. **è™šæ‹Ÿæ»šåŠ¨**: ä½¿ç”¨Element Plusçš„è™šæ‹Ÿè¡¨æ ¼
2. **åˆ†æ‰¹å¤„ç†**: å°†æ•°æ®åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é˜»å¡UI
3. **Web Worker**: å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡æ”¾åˆ°Workerï¼ˆé¢„ç•™ï¼‰
4. **DuckDB**: ä½¿ç”¨DuckDB WASMè¿›è¡ŒSQLæŸ¥è¯¢ï¼ˆé¢„ç•™ï¼‰

```typescript
// ç¤ºä¾‹ï¼šåˆ†æ‰¹å¤„ç†
async function processBatch(data: RawDataRow[], batchSize = 1000) {
  const results = []
  for (let i = 0; i < data.length; i += batchSize) {
    const batch = data.slice(i, i + batchSize)
    results.push(...processBatchData(batch))
    await new Promise(resolve => setTimeout(resolve, 0)) // è®©å‡ºä¸»çº¿ç¨‹
  }
  return results
}
```

---

### 2. æ„å»ºä¼˜åŒ–

**å½“å‰é…ç½®**:
```typescript
// vite.config.ts
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'vue-vendor': ['vue', 'vue-router', 'pinia'],
        'element-plus': ['element-plus', '@element-plus/icons-vue'],
        'charts': ['echarts'],
        'utils': ['lodash-es', 'papaparse', 'dayjs']
      }
    }
  }
}
```

**æ•ˆæœ**:
- Element Plus: 1MB (gzip: 315KB)
- Vue vendor: 105KB (gzip: 41KB)
- Utils: 27KB (gzip: 10KB)

**è¿›ä¸€æ­¥ä¼˜åŒ–**:
1. æŒ‰éœ€å¯¼å…¥Element Plusç»„ä»¶
2. æ‡’åŠ è½½è·¯ç”±
3. å›¾ç‰‡å‹ç¼©å’ŒWebPæ ¼å¼

---

## æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•ï¼ˆè®¡åˆ’ï¼‰

**æµ‹è¯•æ¡†æ¶**: Vitest

**è¦†ç›–èŒƒå›´**:
- å·¥å…·å‡½æ•°: math.ts, date.ts
- æ ¸å¿ƒæœåŠ¡: kpi-calculator.ts, aggregator.ts
- ç›®æ ‡è¦†ç›–ç‡: >80%

**ç¤ºä¾‹**:
```typescript
// kpi-calculator.test.ts
import { describe, it, expect } from 'vitest'
import { kpiCalculator } from '@/services/kpi-calculator'

describe('KPICalculator', () => {
  it('åº”æ­£ç¡®è®¡ç®—å˜åŠ¨æˆæœ¬ç‡', () => {
    const data = [
      { matured_premium_yuan: 10000, reported_claim_payment_yuan: 6000, /* ... */ }
    ]
    const result = kpiCalculator.calculateKPIs(data)
    expect(result.å˜åŠ¨æˆæœ¬ç‡).toBeCloseTo(80, 1)
  })

  it('åˆ†æ¯ä¸º0æ—¶åº”è¿”å›0', () => {
    const data = [{ matured_premium_yuan: 0, /* ... */ }]
    const result = kpiCalculator.calculateKPIs(data)
    expect(result.æ»¡æœŸèµ”ä»˜ç‡).toBe(0)
  })
})
```

---

### 2. é›†æˆæµ‹è¯•ï¼ˆè®¡åˆ’ï¼‰

**æµ‹è¯•åœºæ™¯**:
- å®Œæ•´æ•°æ®æµ: ä¸Šä¼  -> è§£æ -> è®¡ç®— -> å±•ç¤º
- å¤šç§æ•°æ®æ ¼å¼: å•æœºæ„ã€å¤šæœºæ„ã€æœ‰è®¡åˆ’ã€æ— è®¡åˆ’

---

### 3. E2Eæµ‹è¯•ï¼ˆè®¡åˆ’ï¼‰

**æµ‹è¯•æ¡†æ¶**: Playwright

**æµ‹è¯•ç”¨ä¾‹**:
- ç”¨æˆ·ä¸Šä¼ CSVæ–‡ä»¶
- åˆ‡æ¢ä¸åŒç»´åº¦æŸ¥çœ‹KPI
- åˆ‡æ¢TabæŸ¥çœ‹ä¸åŒå›¾è¡¨
- å¯¼å‡ºæŠ¥å‘Š

---

## éƒ¨ç½²ä¸è¿ç»´

### 1. GitHub Actionsè‡ªåŠ¨éƒ¨ç½²

**é…ç½®æ–‡ä»¶**: `.github/workflows/deploy.yml`

**è§¦å‘æ¡ä»¶**:
- pushåˆ°mainåˆ†æ”¯
- pushåˆ°gh-pagesåˆ†æ”¯
- æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰

**éƒ¨ç½²æµç¨‹**:
```yaml
1. Checkoutä»£ç 
2. å®‰è£…Node.js 20
3. å®‰è£…ä¾èµ–: npm ci
4. æ„å»º: npm run build
5. ä¸Šä¼ äº§ç‰©åˆ°GitHub Pages
6. éƒ¨ç½²åˆ°Pagesç¯å¢ƒ
```

**è®¿é—®åœ°å€**: `https://<username>.github.io/autoweKPI/`

---

### 2. ç¯å¢ƒå˜é‡

**å¼€å‘ç¯å¢ƒ**:
```bash
VITE_APP_TITLE=autoweKPI
VITE_APP_VERSION=0.1.0
```

**ç”Ÿäº§ç¯å¢ƒ**:
```bash
NODE_ENV=production
```

---

### 3. ç›‘æ§ä¸æ—¥å¿—

**æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—**:
- æ•°æ®åŠ è½½: è¡Œæ•°ã€åˆ—æ•°ã€è€—æ—¶
- KPIè®¡ç®—: è®¡ç®—è€—æ—¶
- é”™è¯¯ä¿¡æ¯: å‹å¥½çš„é”™è¯¯æç¤º

**æ€§èƒ½ç›‘æ§**:
```typescript
// ä½¿ç”¨Performance API
const start = performance.now()
// ... ä¸šåŠ¡é€»è¾‘
const end = performance.now()
console.log(`è€—æ—¶: ${end - start}ms`)
```

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£é“¾æ¥

- [é¡¹ç›®ç®¡ç†æ–‡æ¡£](PROJECT_MANAGEMENT.md)
- [å¼€å‘æ—¥å¿—](DEVELOPMENT_LOG.md)
- [å¯è¡Œæ€§åˆ†æ](FEASIBILITY_ANALYSIS.md)
- [åŠŸèƒ½æ¸…å•](FEATURE_CHECKLIST.md)
- [æ‰©å±•åŠŸèƒ½è§„åˆ’](EXTENSIONS_PLAN.md)

### å¤–éƒ¨å‚è€ƒ

- [Vue 3æ–‡æ¡£](https://vuejs.org/)
- [TypeScriptæ‰‹å†Œ](https://www.typescriptlang.org/)
- [Piniaæ–‡æ¡£](https://pinia.vuejs.org/)
- [Element Plusæ–‡æ¡£](https://element-plus.org/)
- [EChartsæ–‡æ¡£](https://echarts.apache.org/)
- [Day.jsæ–‡æ¡£](https://day.js.org/)

---

**æ–‡æ¡£ç»´æŠ¤**: æ¯æ¬¡é‡å¤§æ›´æ–°ååŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£
**æœ€åæ›´æ–°**: 2025-12-11
